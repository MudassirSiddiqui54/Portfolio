#include <stdio.h>
#include <stdlib.h>
#include <string.h>

typedef struct Node {
    char name[100];
    int isFile; // 0 = folder, 1 = file
    struct Node *child;
    struct Node *sibling;
    struct Node *parent;
} Node;

Node *createNode(const char *name, int isFile) {
    Node *newNode = (Node *)malloc(sizeof(Node));
    strcpy(newNode->name, name);
    newNode->isFile = isFile;
    newNode->child = NULL;
    newNode->sibling = NULL;
    newNode->parent = NULL;
    return newNode;
}

// Add a child node (file/folder) to a directory
void addChild(Node *parent, Node *newNode) {
    newNode->parent = parent;
    if (parent->child == NULL) {
        parent->child = newNode;
    } else {
        Node *temp = parent->child;
        while (temp->sibling != NULL)
            temp = temp->sibling;
        temp->sibling = newNode;
    }
}

// Print all children of current directory
void ls(Node *current) {
    Node *temp = current->child;
    while (temp != NULL) {
        printf("%s%s  ", temp->name, temp->isFile ? "" : "/");
        temp = temp->sibling;
    }
    printf("\n");
}

// Change directory
Node* cd(Node *current, const char *name) {
    if (strcmp(name, "..") == 0) {
        if (current->parent != NULL)
            return current->parent;
        return current; // Already at root
    }

    Node *temp = current->child;
    while (temp != NULL) {
        if (strcmp(temp->name, name) == 0 && temp->isFile == 0)
            return temp;
        temp = temp->sibling;
    }

    printf("Directory not found: %s\n", name);
    return current;
}

// Print full path from root to current
void pwd(Node *current) {
    if (current->parent != NULL) {
        pwd(current->parent);
        printf("/%s", current->name);
    }
}

int main() {
    Node *root = createNode("", 0); // Root is empty-named folder
    Node *current = root;

    char input[100];
    char *args[3];

    while (1) {
        printf("MyFS");
        pwd(current);
        printf("> ");

        fgets(input, sizeof(input), stdin);
        input[strcspn(input, "\n")] = 0;

        // Tokenize input
        char *token = strtok(input, " ");
        int i = 0;
        while (token != NULL && i < 3) {
            args[i++] = token;
            token = strtok(NULL, " ");
        }
        args[i] = NULL;

        // Command handling
        if (args[0] == NULL) continue;

        if (strcmp(args[0], "exit") == 0)
            break;
        else if (strcmp(args[0], "mkdir") == 0 && args[1])
            addChild(current, createNode(args[1], 0));
        else if (strcmp(args[0], "touch") == 0 && args[1])
            addChild(current, createNode(args[1], 1));
        else if (strcmp(args[0], "ls") == 0)
            ls(current);
        else if (strcmp(args[0], "cd") == 0 && args[1])
            current = cd(current, args[1]);
        else if (strcmp(args[0], "pwd") == 0) {
            printf("/");
            pwd(current);
            printf("\n");
        }
        else
            printf("Unknown or incomplete command\n");
    }

    return 0;
}